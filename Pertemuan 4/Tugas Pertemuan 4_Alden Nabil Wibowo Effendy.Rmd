---
title: "Pertemuan 3 - Regresi dengan Peubah Lag"
author:
- Alden Nabil Wibowo Effendy
output:
  html_document:
    theme: yeti
    toc: true
    toc_float: true
  word_document: default
  pdf_document: default
---

## *Packages*

```{r}
library(dLagM)
library(dynlm)
library(MLmetrics)
library(lmtest)
library(car)
```

## Impor Data

```{r}
data <- rio::import("https://raw.githubusercontent.com/aldennabil/MPDW/refs/heads/main/Pertemuan%203/NewDelhi_Air_quality.csv")
str(data)
data
```

## Eksplorasi Data

```{r}
library(ggplot2)

ggplot(data, aes(x = timestamp_local, y = AQI)) +
  geom_line(color = "steelblue") +
  labs(title = "Time Series AQI",
       x = "Waktu",
       y = "Air Quality Index (AQI)") +
  theme_minimal()
```

```{r}
num_vars <- c("CO", "no2", "o3", "pm10", "pm25", "so2")

for (v in num_vars) {
  print(
    ggplot(data, aes_string(x = v, y = "AQI")) +
      geom_point(alpha = 0.6) +
      geom_smooth(method = "lm", se = FALSE, color = "red") +
      labs(title = paste("AQI vs", v)) +
      theme_minimal()
  )
}
```

Terlihat beberapa peubah berkorelasi, lebih jelasnya kita pakai plot korelasi

### Melihat Korelasi

```{r}
library(corrplot)

num_df <- data[, c("AQI", num_vars)]
cor_mat <- cor(num_df, use = "complete.obs")

corrplot(cor_mat, method = "color", type = "upper",
         addCoef.col = "black", number.cex = 0.7,
         tl.col = "black", tl.srt = 45)
```

Terlihat bahwa AQI berkorelasi sangat kuat terhadap $O_3$ dengan nilai 0,97. Maka kita akan analisis peubah lag dengan nilai $Xt = O_3$ dan $Yt = AQI$

## Pembagian Data

```{r}
data$Xt <- data$o3
data$Yt <- data$AQI

#SPLIT DATA
train<-data[1:57,] # 80% data pertama
test<-data[58:72,] # 20% data sisanya
```

```{r}
#data time series
train.ts<-ts(train)
test.ts<-ts(test)
data.ts<-ts(data)
```

## Model Linear dan Pengecekan Asumsi

```{r}
model <- lm(train$Yt ~ train$Xt, data = train)
summary(model)
```

```{r}
# Uji normalitas residual
shapiro.test(residuals(model))   # Shapiro-Wilk Test

# Uji Breusch-Pagan (butuh library lmtest)
library(lmtest)
bptest(model)

# Uji Durbin-Watson (autokorelasi)
library(lmtest)
dwtest(model)
```

Terdeteksi autokorelasi sehingga diperlukan penanganan

## Model Koyck

**Intuisi:** Model Koyck memiliki asumsi **pengaruh dari masa lalu akan semakin melemah seiring berjalannya waktu**.

```{r}
#MODEL KOYCK
model.koyck <- koyckDlm(x = train$Xt, y = train$Yt)
summary(model.koyck)
AIC(model.koyck)
BIC(model.koyck)
```

**Interpretasi Hasil:**

-   Dari `summary`, kita dapatkan model:

    $$
    \hat{Y_t}=0.54798+0.25830X_t+0.41955Y_{t-1}
    $$

-   didapat bahwa peubah $x_t$ dan $y_{t-1}$ memiliki nilai P-Value\<0.05 (signifikan). Hal ini menunjukkan bahwa kedua peubah berpengaruh signifikan terhadap $y$. Nilai AQI saat ini dipengaruhi oleh kandungan $O_3$ pada saat ini, serta nilai AQI satu hari sebelumnya.

### Peramalan dan Akurasi

Berikut adalah hasil peramalan y untuk 15 periode kedepan menggunakan model koyck

```{r}
fore.koyck <- forecast(model = model.koyck, x=test$Xt, h=15)
fore.koyck
mape.koyck <- MAPE(fore.koyck$forecasts, test$Yt)
mape.koyck #data test
#akurasi data training
GoF(model.koyck)
```

## Regression with Distributed Lag

Model DLM lebih fleksibel. Ia **tidak membuat asumsi** tentang pola peluruhan pengaruh. Sebaliknya, ia mencoba mengestimasi koefisien untuk **setiap lag secara terpisah**.

### *Lag* Optimum

Kita bisa meminta R untuk mencari panjang lag yang paling optimal berdasarkan kriteria informasi seperti **AIC** untuk menyeimbangkan antara kecocokan model dengan kompleksitasnya.

```{r}
#penentuan lag optimum 
finiteDLMauto(formula = Yt ~ Xt,
              data = data.frame(train), q.min = 1, q.max = 10,
              model.type = "dlm", error.type = "AIC", trace = TRUE)
```

Berdasarkan output tersebut, lag optimum didapatkan ketika lag=10. Selanjutnya dilakukan pemodelan untuk lag=10

```{r}
#model dlm dengan lag optimum
model.dlm2 <- dlm(x = train$Xt,y = train$Yt , q = 10)
summary(model.dlm2)
AIC(model.dlm2)
BIC(model.dlm2)
```

Terdapat beberapa peubah yang berpengaruh signifikan terhadap taraf nyata 5% yaitu $x_t$ , $x_{t-7}$ , $x_{t-8}$ , $x_{t-9}$, $x_{t-10}$. Artinya, menurut model DLM dengan $q=10$, nilai AQI saat ini dipengaruhi oleh kandungan $O_3$ pada saat ini, 7 hari sebelumnya, 8 hari sebelumnya, 9 hari sebelumnya, dan 10 hari sebelumnya. Adapun keseluruhan model yang terbentuk adalah

$$ \hat{Y_t}=-0.294780 + 0.405638X_t+...-0.098958X_{t-10} $$

Adapun hasil peramalan 15 periode kedepan menggunakan model tersebut adalah sebagai berikut

```{r}
#peramalan dan akurasi
fore.dlm2 <- forecast(model = model.dlm2, x=test$Xt, h=15)

#akurasi data test
mape.dlm2<- MAPE(fore.dlm2$forecasts, test$Yt)
mape.dlm2

#akurasi data training
GoF(model.dlm2)
```

MAPE test $0.01274404$ dan MAPE train $0.007238929$. Artinya model tersebut merupakan model yang sangat baik dengan nilai MAPE yang kurang dari 1%.

## Model Autoregressive

**Intuisi:** ARDL adalah model "hibrida" yang paling lengkap. Ia menggabungkan dua ide:

1.  **Distributed Lag (DL):** $Y_t$ dipengaruhi oleh nilai X di masa lalu $(X_{t−1},X_{t−2},\dots)$.

2.  **Autoregressive (AR):** Y_t juga dipengaruhi oleh nilainya sendiri di masa lalu $(Y_{t−1},Y_{t−2},\dots)$. Ini menangkap adanya "momentum" atau "inersia" dalam data.

Data di atas merupakan hasil peramalan untuk 5 periode ke depan menggunakan Model Autoregressive dengan $p=1$ dan $q=1$.

### *Lag* Optimum

```{r}
#penentuan lag optimum
model.ardl.opt <- ardlBoundOrders(data = data.frame(data), ic = "AIC", 
                                  formula = Yt ~ Xt )
model.ardl.opt
min_p=c()
for(i in 1:15){
  min_p[i]=min(model.ardl.opt$Stat.table[[i]])
}
q_opt=which(min_p==min(min_p, na.rm = TRUE))
p_opt=which(model.ardl.opt$Stat.table[[q_opt]] == 
              min(model.ardl.opt$Stat.table[[q_opt]], na.rm = TRUE))
data.frame("q_optimum" = q_opt, "p_optimum" = p_opt, 
           "AIC"=model.ardl.opt$min.Stat)
```

Dari tabel di atas, dapat terlihat bahwa nilai AIC terendah didapat ketika $p=13$ dan $q=2$ . Artinya, lag optimum untuk peubah $X_t$ $(O_3)$ adalah 13 hari sebelumnua sedangkan lag optimum untuk peubah $Y_t$ $(AQI)$ adalah 2 hari. Selanjutnya nilai ini akan dimasukkan ke dalam proses pembentukan model ardl.

```{r}
model.ardl2 <- ardlDlm(formula = Yt ~ Xt, 
                         data = train,p = 13, q = 2)
summary(model.ardl2)
AIC(model.ardl2)
```

Terdapat 2 peubah yang berpengaruh signifikan terhadap nilai $AQI$ pada selang kepercayaan 95% yaitu $X_t$ dan $X_{t-8}$. Artinya, nilai AQI saat ini dipengaruhi oleh kandungan $O_3$ pada saat ini, serta 8 hari sebelumnya. Model keseluruhannya adalah sebagai berikut:

$$ \hat{Y}=-0.77136+ 0.39407X_t+0.20786 X_{t-1}+...-0.12772Y_{t-1}+0.06633Y_{t-2} $$

```{r}
fore.ardl <- forecast(model = model.ardl2, x=test$Xt, h=15)
fore.ardl
```

```{r}
#akurasi data testing
mape.ardl <- MAPE(fore.ardl$forecasts, test$Yt)

#akurasi data training
mape.ardl.train <- GoF(model.ardl2)["MAPE"]
```

Aman juga

## Perbandingan Model

```{r}
akurasi <- matrix(c(mape.koyck, mape.dlm2, mape.ardl))
row.names(akurasi)<- c("Koyck","DLM","Autoregressive")
colnames(akurasi) <- c("MAPE")
akurasi
```

Berdasarkan nilai MAPE, model paling optimum didapat pada Model DLM karena memiliki nilai MAPE yang terkecil.

### Plot

```{r}
par(mfrow=c(1,1))
plot(test$Xt, test$Yt, type="b", col="black")
points(test$Xt, fore.koyck$forecasts,col="red")
lines(test$Xt, fore.koyck$forecasts,col="red")
points(test$Xt, fore.dlm2$forecasts,col="blue")
lines(test$Xt, fore.dlm2$forecasts,col="blue")
points(test$Xt, fore.ardl$forecasts,col="green")
lines(test$Xt, fore.ardl$forecasts,col="green")
legend("topleft",c("aktual", "koyck","DLM", "autoregressive"), lty=1, col=c("black","red","blue","green"), cex=0.8)
```

Berdasarkan plot tersebut, terlihat bahwa plot yang paling mendekati data aktualnya adalah Model DLM, sehingga dapat disimpulkan model terbaik dalam hal ini adalah $model regresi DLM$ dengan Mean Absolute Percentage Error (MAPE) sebesar $0.01274404$
